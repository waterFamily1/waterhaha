(window.webpackJsonp=window.webpackJsonp||[]).push([[84],{1175:function(e,t,a){"use strict";a.r(t);var n=function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("div",{staticClass:"c-main-border"},[a("div",{staticClass:"c-left-border-blue"},[a("div",{staticClass:"c-search-main"},[a("div",{staticClass:"c-form-item"},[a("label",[e._v("所属组织：")]),a("dropdown-tree",{ref:"orgTree",staticStyle:{width:"200px"},attrs:{url:e.treeApi.getOrgTreeData},model:{value:e.org,callback:function(t){e.org=t},expression:"org"}})],1),e._v(" "),a("div",{staticClass:"c-form-item"},[a("label",[e._v("时间：")]),e._v(" "),a("DatePicker",{staticStyle:{width:"200px"},attrs:{type:"date",placeholder:"请选择日期",format:"yyyy-MM-dd",clearable:!1},model:{value:e.executeDate,callback:function(t){e.executeDate=t},expression:"executeDate"}})],1),e._v(" "),a("div",{staticClass:"c-adv-search-btn"},[a("Button",{attrs:{type:"primary",shape:"circle"},on:{click:e.search}},[e._v("搜索")]),e._v(" "),a("Button",{staticClass:"c-btn-reset",attrs:{type:"primary",shape:"circle"},on:{click:e.searchParamsClean}},[e._v("重置")])],1)])]),e._v(" "),a("div",{staticClass:"c-top-border-gray",staticStyle:{padding:"0"}},[a("div",{staticClass:"c-scrollbar",staticStyle:{float:"left",overflow:"auto"},style:e.boundStyle},[a("Table",{attrs:{columns:e.columns,data:e.listData,stripe:"",loading:e.loading,width:"900"},on:{"on-select-cancel":e.onSelect,"on-selection-change":e.onSelect}})],1),e._v(" "),a("div",{staticStyle:{float:"left",position:"relative"},style:e.boundStyle},[a("div",{style:e.boundStyle,attrs:{id:"patrol-trace-map"}}),e._v(" "),a("span",{directives:[{name:"show",rawName:"v-show",value:e.mapLoading,expression:"mapLoading"}],staticStyle:{position:"absolute",left:"20px",top:"10px",color:"#999"}},[e._v("正在加载地图...")]),e._v(" "),a("div",{staticClass:"bdmap-search"},[a("Icon",{attrs:{type:"ios-search",size:"20",color:"#CCCCCC"}}),e._v(" "),a("input",{staticClass:"bdmap-search-key",attrs:{type:"text",id:"bdmap-search-key"}})],1)])])])};n._withStripped=!0;var i,o=a(23),r=a(145),l=a(11),s=a(558),p=a(539),d=a(107),c=(a(39),l.a.F(new Date)+" 00:00:00"),u={data:function(){return{mapLoading:!0,boundStyle:{width:"100%",height:"100%"},treeApi:d.a,loading:!1,org:{id:"",title:"请选择"},executeDate:c,searchParams:{orgId:"",executeDate:l.a.transDateFromLocale(c),pageSize:1e3,currentPage:1},columns:[{type:"selection",width:50},{title:"巡检任务",key:"name"},{title:"任务编号",key:"no"},{title:"状态",key:"executeStatus",width:80},{title:"巡检点",key:"inspectedCount",width:80,render:function(e,t){return e("span",t.row.inspectedCount+"/"+t.row.patrolPointCount)}},{title:"结果记录",key:"hasResultCount",width:120,renderHeader:function(e){return e("span",{attrs:{title:"结果记录"}},"结果记录")},render:function(e,t){return e("span",t.row.hasResultCount+"/"+t.row.stepCount)}},{title:"报缺",key:"faultCount",width:60},{title:"执行人",key:"executorName",width:120},{title:"结束时间",key:"endTime",width:120,render:function(e,t){return e("span",l.a.transDateFromServer(t.row.endTime,"hh:mm:ss"))}}],listData:[]}},computed:Object(o.b)({patrol:function(e){return e.map.patrol}}),methods:{getData:function(){var e=this;this.loading=!0;var t=this.patrol.task.state;this.$http.get(p.a.trace,this.searchParams).then((function(a){if(e.loading=!1,a){if(e.total=a.total,a.items.forEach((function(e){e._checked=!0,e.executeStatus=t[e.executeStatus]})),e.listData=a.items,e.onSelect(a.items),0==a.total)return void s.a.placePoint(i,(function(){e.mapLoading=!1}));e.mapLoading=!1}}))},search:function(){this.searchParams.orgId=this.org.id,this.searchParams.currentPage=1,this.searchParams.executeDate=l.a.transDateFromLocale(this.executeDate),this.getData()},searchParamsClean:function(e){this.org={id:"",title:"请选择"},this.executeDate=c,this.searchParams={orgId:"",executeDate:l.a.transDateFromLocale(c),pageSize:1e3,currentPage:1}},onSelect:function(e){if(i.clearOverlays(),e.length){for(var t={},a=0;a<e.length;a++){var n=e[a];t[n.patrolPlanId]?t[n.patrolPlanId].push(n):t[n.patrolPlanId]=[n]}var o=[],r=[];for(var l in t){var p=t[l],d=p.length-1,c=p[d].patrolTaskPointTrackDTOs;r.push(p[d]),c.length&&c.forEach((function(e){o.push(e)}))}var u=s.a.getBDPoints(o);i.setViewport(u),i.panBy(1,1),r.forEach((function(e){s.a.drawPatrol(i,e)}))}}},components:{dropdownTree:r.a},created:function(){l.a.initTableColumnTitle(this.columns)},mounted:function(){var e=this,t=document.querySelector(".lay").offsetHeight-60,a=document.querySelector(".lay").offsetWidth/2-5;this.boundStyle.width=a+"px",this.boundStyle.height=t+"px",s.a.create((function(){(i=new BMap.Map("patrol-trace-map")).enableScrollWheelZoom(),s.a.setStyle(i),e.getData(),s.a.addSearch(i)}))}},f=a(1),h=Object(f.a)(u,n,[],!1,null,null,null);h.options.__file="src/views/patrol/trace.vue";t.default=h.exports},539:function(e,t,a){"use strict";var n=a(22),i={getTasks:"/patrol/api/tasks",getTaskDetail:"/patrol/api/tasks",delTasks:"/patrol/api/tasks",modifyTask:"/patrol/api/tasks",stop:"/patrol/api/tasks",updatePatrolTaskPoint:"/patrol/api/task-point-step",plan:"/patrol/api/plans",getPlan:"/patrol/api/plans",updatePlan:"/patrol/api/plans",deletePlan:"/patrol/api/plans",planPath:"/patrol/api/plan-path",releasePlan:"/patrol/api/plans/release",interruptPlan:"/patrol/api/plans/interrupt",statistics:"/patrol/api/tasks/statistics",export:n.a+"/patrol/api/tasks/statistics-export",point:"/patrol/api/points",getQrcode:n.a+"/patrol/api/points/qrcode-export",trace:"/patrol/api/tasks/map-track"};t.a=i},558:function(e,t,a){"use strict";var n=a(7),i=a(11);function o(e,t){return{lng:(e.lng+t.lng)/2,lat:(e.lat+t.lat)/2}}var r=a(559),l=a(560),s=a(561),p=a(562),d=a(563),c=a(564),u=a(565),f=a(566),h=(new n.default,[{featureType:"all",elementType:"all",stylers:{lightness:10,saturation:-100}}]);t.a={create:function(e){if("undefined"==typeof BMap){var t=document.createElement("script");t.src="https://api.map.baidu.com/api?v=2.0&ak=0lPULNZ5PmrFVg76kFuRjezF&callback=MG__MAP__CALLBACK",document.body.appendChild(t),window.MG__MAP__CALLBACK=function(){e&&e()}}else e&&e()},addTiles:function(e){if(e){var t=new BMap.TileLayer({isTransparentPng:!0});t.getTilesUrl=function(e,t){return"/images/tiles/"+t+"/"+e.x+"/"+e.y+".png"},e.addTileLayer(t)}},placePoint:function(e,t){e&&(new BMap.Geolocation).getCurrentPosition((function(a){var n={lng:121.480576,lat:31.235906};this.getStatus()==BMAP_STATUS_SUCCESS&&(n.lng=a.point.lng,n.lat=a.point.lat),e.centerAndZoom(new BMap.Point(n.lng,n.lat),15),t&&t(n)}),{enableHighAccuracy:!0})},setStyle:function(e){e&&e.setMapStyle({styleJson:h})},setZoom:function(e,t,a){var n=e.getViewport(t.map((function(e){return{lng:e.longitude,lat:e.latitude}}))),i=n.zoom,o=n.center;e.centerAndZoom(o,a||i)},drawPatrolTask:function(e,t){var a,n=t.patrolPointDetailDTOs||[],i=t.patrolTaskPlanPaths||[];if(e&&n.length&&i.length&&(this.setZoom(e,n),n.forEach((function(t){var n=new BMap.Point(t.longitude,t.latitude);switch(t.status){case"正常":a=new BMap.Icon(l,new BMap.Size(16,21));break;case"异常":a=new BMap.Icon(p,new BMap.Size(16,21));break;case"未检":a=new BMap.Icon(s,new BMap.Size(16,21),{anchor:new BMap.Size(8,21)});break;default:a=new BMap.Icon(r,new BMap.Size(16,21))}var i=new BMap.Marker(n,{icon:a});e.addOverlay(i);var o=new BMap.Label(t.patrolPoint,{position:n,offset:new BMap.Size(10,-15)});o.setStyle({borderColor:"#0093ff",color:"#0093ff"}),e.addOverlay(o);var d="",c="";t.uninspectedStep&&t.uninspectedStep.length?t.uninspectedStep.forEach((function(e){c+="<li>"+e+"</li>"})):c="<li>无</li>","异常"==t.status&&(d="<div ><div style='padding:2px 0 2px 0;font-weight:bold;border-bottom:solid 1px #eee;'>漏检结果</div><ul style='padding-top:2px;clear:both;color:gray;'>"+c+"</ul></div>");var u=new BMap.InfoWindow("<div style='overflow:auto;'><div style='font-size:large;font-weight:bold;'>"+t.patrolPoint+"</div><div><div style='padding:2px 0 2px 0;font-weight:bold;border-bottom:solid 1px #eee;'>报缺数</div>"+t.faultCount+"</div>"+d+"</div>",{width:0,height:0,title:"",enableMessage:!1});i.addEventListener("click",(function(){e.openInfoWindow(u,n)}))})),!(i.length<2)))for(var o=[],d=0,c=i.length;d<=c;d++){var u,f,h;d!=c&&(u=i[d],f=new BMap.Point(u.longitude,u.latitude)),o.length<2?o.push(f):(h=new BMap.Polyline(o,{strokeColor:"valid"==u.validate?"#3a6bdb":"#9b9b9b",strokeWeight:4}),e.addOverlay(h),d!=c&&(o=[o[1],f]))}},drawPatrol:function(e,t,a){var n,r=t.patrolTaskPointTrackDTOs||[],d=t.patrolTaskPlanPaths||[];if(e&&r.length&&d.length&&(this.setZoom(e,r),r.forEach((function(t){var a=new BMap.Point(t.longitude,t.latitude);switch(t.status){case"正常":n=new BMap.Icon(l,new BMap.Size(16,21));break;case"异常":n=new BMap.Icon(p,new BMap.Size(16,21));break;case"未检":n=new BMap.Icon(s,new BMap.Size(16,21),{anchor:new BMap.Size(8,21)})}var i=new BMap.Marker(a,{icon:n});e.addOverlay(i);var o=new BMap.Label(t.patrolPointName,{position:a,offset:new BMap.Size(10,-15)});o.setStyle({borderColor:"#0093ff",color:"#0093ff"}),e.addOverlay(o);var r="",d="";t.uninspectedStep&&t.uninspectedStep.length?t.uninspectedStep.forEach((function(e){d+="<li>"+e+"</li>"})):d="<li>无</li>","异常"==t.status&&(r="<div ><div style='padding:2px 0 2px 0;font-weight:bold;border-bottom:solid 1px #eee;'>漏检结果</div><ul style='padding-top:2px;clear:both;color:gray;'>"+d+"</ul></div>");var c=new BMap.InfoWindow("<div style='overflow:auto;'><div style='font-size:large;font-weight:bold;'>"+t.patrolPointName+"</div><div><div style='padding:2px 0 2px 0;font-weight:bold;border-bottom:solid 1px #eee;'>报缺数</div>"+t.faultCount+"</div>"+r+"</div>",{width:0,height:0,title:"",enableMessage:!1});i.addEventListener("click",(function(){e.openInfoWindow(c,a)}))})),!(d.length<2)))for(var c=new BMap.InfoWindow("<h5>"+t.name+"</h5><div>"+t.executeStatus+"</div><div>时间："+i.a.transDateFromServer(t.startTime,"hh:mm")+" - "+i.a.transDateFromServer(t.endTime,"hh:mm")+"</div><div>发现缺陷："+t.faultCount+"</div><div>巡检点："+t.inspectedCount+"/"+t.patrolPointCount+"</div><div>计划距离："+t.planPathLength+"米</div><div>有效距离："+t.validPathLength+"米</div>",{width:270,height:140,title:"",enableMessage:!1}),u=[],f=0,h=d.length;f<=h;f++){var g,v,w;f!=h&&(g=d[f],v=new BMap.Point(g.longitude,g.latitude)),u.length<2?u.push(v):((w=new BMap.Polyline(u,{strokeColor:"valid"==g.validate?"#3a6bdb":"#9b9b9b",strokeWeight:4})).addEventListener("mouseover",(function(){this.setStrokeStyle("dashed")})),w.addEventListener("mouseout",(function(){this.setStrokeStyle("solid")})),w.addEventListener("click",(function(t){var a=t.target.getPath()[0],n=t.target.getPath()[1];e.openInfoWindow(c,new BMap.Point(o(a,n).lng,o(a,n).lat))})),e.addOverlay(w),f!=h&&(u=[u[1],v]))}},addSearch:function(e,t,a){new BMap.Autocomplete({input:t||"bdmap-search-key",location:e}).addEventListener("onconfirm",(function(t){var n=t.item.value,i=n.province+n.city+n.district+n.street+n.business,o=new BMap.LocalSearch(e,{onSearchComplete:function(){var t=o.getResults().getPoi(0).point;e.centerAndZoom(t,18),a&&a(t)}});o.search(i)}))},getBDPoints:function(e){if(!e)return[];var t=[];return e.forEach((function(e){e.longitude&&e.latitude&&t.push(new BMap.Point(e.longitude,e.latitude))})),t},hitPoint:function(e,t,a){"[object Array]"!==Object.prototype.toString.call(t)&&(t=[t]),t.forEach((function(t){if(t.longitude&&t.latitude){var n=new BMap.Point(t.longitude,t.latitude),i=new BMap.Marker(n,{icon:new BMap.Icon(r,new BMap.Size(16,21))});a&&"boolean"==typeof a?i.disableDragging():"function"==typeof a&&(i.enableDragging(),i.addEventListener("dragend",(function(e){a(e)})));var o=new BMap.Label(t.patrolPoint,{offset:new BMap.Size(20,-10)});o.setStyle({borderColor:"#0093ff",color:"#0093ff"}),i.setLabel(o),i.setTitle(t.id),e.addOverlay(i)}}))},renderLine:function(e,t,a){var n=new BMap.Polyline(t,Object.assign({enableEditing:!1,enableClicking:!0,strokeWeight:"5",strokeOpacity:.65},a||{}));return e.addOverlay(n),n},hitProcess:function(e,t,a,n){var i=[],o=[];return t.forEach((function(t,n){if(t.longitude&&t.latitude){var r=t.handleStatus?d:c,l=new BMap.Point(t.longitude,t.latitude),s=new BMap.Marker(l,{icon:new BMap.Icon(r,new BMap.Size(36,30))}),p=(12*t.name.length+20)/2,u=new BMap.Label(t.name,{offset:new BMap.Size(18-p,-26)});u.setStyle({backgroundColor:"#FFFFFF",borderColor:"#FFFFFF",color:"#4A4A4A",borderRadius:"2px",boxShadow:"2px 2px 4px 0px rgba(0,0,0,0.13)",padding:"3px 10px",cursor:"pointer"}),s.setLabel(u),s.setZIndex(2e3+n),e.addOverlay(s),o.push(s),u.addEventListener("click",(function(){a&&a(this,l,t)})),s.addEventListener("click",(function(){a&&a(this,l,t)})),i.push(l)}})),n&&n(o),i},hitStaff:function(e,t,a,n){var i=[],o=[];return t.forEach((function(t,n){if(t.longitude&&t.latitude){var r=1==t.haveTask?u:f,l=new BMap.Point(t.longitude,t.latitude),s=new BMap.Marker(l,{icon:new BMap.Icon(r,new BMap.Size(23,32))}),p=(12*t.userName.length+20)/2,d=new BMap.Label(t.userName,{offset:new BMap.Size(12-p,-26)});d.setStyle({backgroundColor:"#FFFFFF",borderColor:"#FFFFFF",color:"#4A4A4A",borderRadius:"2px",boxShadow:"2px 2px 4px 0px rgba(0,0,0,0.13)",padding:"3px 10px"}),s.setLabel(d),s.setZIndex(1e3+n),e.addOverlay(s),o.push(s),s.addEventListener("click",(function(){a&&a(this,l,t)})),i.push(l)}})),n&&n(o),i}}},559:function(e,t,a){e.exports=a.p+"images/f2b760922921a7f0fd4d402145d6dbd5.png"},560:function(e,t,a){e.exports=a.p+"images/5a97737f8744e4f0a37e9eadcaae7469.png"},561:function(e,t,a){e.exports=a.p+"images/e91e0c308e4bdfa03605696ce3358b1b.png"},562:function(e,t,a){e.exports=a.p+"images/bd4523e3b67968731b5d77d0a89dcb9f.png"},563:function(e,t,a){e.exports=a.p+"images/6cc09be5e8a6202e732126b57d5d92da.png"},564:function(e,t,a){e.exports=a.p+"images/96e02f4efb20c9a13722cc8ae3fd59d8.png"},565:function(e,t,a){e.exports=a.p+"images/5980ed2516736ab58921267e07915b43.png"},566:function(e,t,a){e.exports=a.p+"images/1316c96a11c16e1faf98fa712e4b33c8.png"}}]);